# DOS Message System & Localization

## Overview

This documents the DOS message/localization system across versions, the extraction
tools we built, and the coverage analysis.

---

## Message System History

### DOS 1.x-3.x: Hardcoded Strings

Early DOS used simple hardcoded strings embedded directly in assembly source:

```asm
; DOS 2.0 FORMES.ASM
BADVER  DB  "Incorrect DOS version",13,10,"$"
SNGMSG  DB  "Insert new diskette for drive "
SNGDRV  DB  "x:",13,10,"and strike any key when ready$"
INVDRV  DB  "Invalid drive specification$"
```

**Characteristics:**
- `$`-terminated strings (DOS print function convention)
- Inline `DB` directives in separate *MES.ASM files per utility
- No structured format, no message IDs
- Localization required editing source and reassembling
- No message extraction possible from binaries (no structure to match against)

**Confirmed via source code examination:**
- DOS 2.0: FORMES.ASM, CHKMES.ASM, DEBMES.ASM, SORTMES.ASM, RECMES.ASM, etc.
- Grep for BUILDMSG/$M_CLASS/$M_ID in DOS 2.0 returned zero results
- DOS 3.3: No .MSG/.SKL files in leaked OAK repo. Likely same hardcoded system.

### DOS 3.3: Improved Internationalization (But Not Structured Messages)

DOS 3.3 added significant NLS infrastructure, but NOT the structured message system:
- **COUNTRY.SYS** -- country-specific formatting (date, time, currency, separators)
- **KEYBOARD.SYS** -- compressed keyboard layout data (17 layouts)
- **KEYB.COM** -- generic keyboard driver that reads from KEYBOARD.SYS
- **NLSFUNC** -- National Language Support runtime
- Code page support (CP437, CP850, CP860, CP863, CP865)

Messages were still hardcoded in the utilities themselves.

### DOS 4.0: Structured BUILDMSG System (First Version)

DOS 4.0 introduced a formal message compilation system, likely as part of the IBM
joint development effort to support international DOS releases more efficiently.

**Build Pipeline:**

```
  .SKL file           .MSG file
  (skeleton)          (message database)
  per-utility         usa-ms.msg (English)
       |                    |
       +--------+-----------+
                |
         BUILDMSG.EXE
                |
         .CL* files (.CLA, .CLB, .CLC, etc.)
         (compiled message class assembly)
                |
           MASM (assembler)
                |
         Object code linked into executable
```

### DOS 5.0-6.0: Same System (Inherited)

The structured message system continued unchanged through DOS 5 and 6.

---

## Binary Message Format (DOS 4.0+)

### Class Header (4 bytes)

```
Offset  Size  Description
------  ----  -----------
0       1     Class ID
1       2     Expected DOS Version (little-endian, e.g., 00 04 = DOS 4.00)
3       1     Message Count
```

### Message ID Table (4 bytes per message, immediately follows header)

```
Offset  Size  Description
------  ----  -----------
0       2     Message ID (little-endian)
2       2     Offset to message text
```

Offsets are self-relative from the ID table entry position, NOT from
the class header. This matches the assembler directive:
```asm
$M_ID <msgID, $M_MSG-$M_STRUC>
```

### Message Data (variable length, follows ID table)

```
Offset  Size  Description
------  ----  -----------
0       1     Length byte (number of text bytes following)
1       N     Message text (CP437/CP850 encoded)
```

### Message Class IDs

| ID | Name | Purpose |
|----|------|---------|
| 0x01 | EXTEND | Extended error messages (INT 21h AH=59h errors) |
| 0x02 | PARSE | Command-line parse errors |
| 0x0A | CLASS_A | Utility-specific messages (class A, resident) |
| 0x0B | CLASS_B | Utility-specific messages (class B) |
| 0x0C | CLASS_C | Utility-specific messages (class C) |
| 0xFF | UTILITY | Main utility messages |

---

## Message File Formats

### .MSG Files (Source Message Database)

Human-readable text format. Example from `usa-ms.msg`:

```
0085
UTILITY   0012 0001
0015 U 0000 "Parameters not supported",CR,LF
0016 U 0000 "Format terminated",CR,LF
```

Fields:
- `0085` -- message file format version
- `UTILITY` -- class name
- `0012` -- message count (hex)
- `0001` -- reserved
- `0015` -- message ID (hex)
- `U 0000` -- flags (U = utility)
- String with CR/LF markers

### .SKL Files (Skeleton Definitions)

Per-utility message templates. Define message numbers and default text. Example:
```
:def 1040 "Microsoft DOS             Version %1.%2"
```

The .MSG file overrides .SKL defaults at build time via BUILDMSG.

### .CL* Files (Compiled Assembly Output)

Generated by BUILDMSG. Assembly source that gets assembled and linked into the
executable. Example from `format.clb`:

```asm
$M_CLASS_B_STRUC LABEL BYTE
    $M_CLASS_ID <0FFH,EXPECTED_VERSION,Class_B_MessageCount>
$M_B_00015H_STRUC LABEL BYTE
    $M_ID <00015H,$M_B_00015H_MSG-$M_B_00015H_STRUC>
$M_B_00015H_MSG LABEL BYTE
    DB $M_B_00015H_END-$M_B_00015H_MSG-1
    DB CR,"Parameters not supported",CR,LF
$M_B_00015H_END LABEL BYTE
```

File extensions indicate class: .CLA (class A), .CLB (class B), .CLC (class C).

### Message Service Structures

Defined in `v4.0/src/INC/MSGSERV.ASM`:
- `$M_CLASS_ID` -- class header macro
- `$M_ID` -- message ID entry macro
- `$M_SUBLIST_STRUC` -- substitution list for parameterized messages
- Runtime functions: SYSLOADMSG, SYSDISPMSG, SYSGETMSG

---

## Extraction Tools

### tools/parse_cl_files.py

Parses English .CL* assembly files to extract message structure (class ID, message
count, message IDs, and text).

```bash
python3 tools/parse_cl_files.py format.clb
```

**Key implementation details:**
- Extracts class ID from `$M_CLASS_ID <0FFH,...>` pattern
- Parses message labels: `$M_B_00015H_MSG LABEL BYTE`
- Handles DB directives with string literals, CR, LF, hex values
- Provides the "reference template" that the binary extractor uses

### tools/extract_localized_messages.py

Extracts localized messages from DOS executables using the English .CL* file as a
structural reference.

```bash
python3 tools/extract_localized_messages.py format.clb dutch_format.com > dutch_format.msg
```

**Algorithm:**
1. Parse English .CL* file to learn class ID, expected message count, expected IDs
2. Scan localized binary for matching class header (same class ID, same count, DOS
   4.00 version signature)
3. Verify structure: message IDs match, offsets point to valid length-prefixed strings,
   text is mostly printable ASCII (70% threshold)
4. Extract messages using SELF-RELATIVE offsets from ID table entries
5. Export as .MSG file compatible with BUILDMSG

**Encoding priority:** CP850 (multilingual) -> CP437 (US) -> Latin-1 (fallback)

### tools/dos_msg_extract.py

Standalone extractor that works without a .CL* reference file. Scans executables for
any valid message class structure. Less precise but useful for exploration.

```bash
python3 tools/dos_msg_extract.py FORMAT.COM
```

---

## Coverage Analysis

### Extractable Messages (DOS 4.0+)

| Category | Utilities | Classes | Messages |
|----------|-----------|---------|----------|
| Commands | 37 | 133 | 876 |
| Devices | 5 | 15 | 50 |
| Core | 1 | 4 | 22 |
| **Total** | **48** | **152** | **948** |

Plus 98 shared messages in COMMON section (usa-ms.msg) = **1,046 total**

Plus ~90 extended error messages + ~11 parse error messages = **~1,137 total**

### Tested Utilities (100% extraction success)

- COMMAND.COM (32 messages)
- FORMAT.COM (20 messages)
- CHKDSK.COM (19 messages)
- MODE.COM (28 messages)
- FDISK.EXE (6 messages)
- DEBUG.COM (4 messages)
- KEYB.COM (18 messages)
- SYS.COM (1 message)

### What Cannot Be Extracted

- SELECT installer UI text (~3,500 lines, USA.INF format -- different system)
- Help files (.HLP format -- separate format)
- Hardcoded system strings (CONFIG.SYS directives, switch characters, etc.)
- DOS Shell (DOSSHELL) text -- source not open-sourced

---

## Localization Infrastructure in DOS 4.0

### Keyboard Layouts (KEYBOARD.SYS)

17 keyboard definitions in `v4.0/src/DEV/KEYBOARD/`:

| File | Country/Layout |
|------|----------------|
| KDFBE.ASM | Belgium |
| KDFCA.ASM | Canadian French |
| KDFDK.ASM | Denmark |
| KDFFR.ASM | France |
| KDFGE.ASM | Germany |
| KDFGR.ASM | Greece |
| KDFHE.ASM | Hebrew (Israel) |
| KDFHK.ASM | Hong Kong |
| KDFIT.ASM | Italy |
| KDFLA.ASM | Latin America |
| KDFNL.ASM | Netherlands |
| KDFNO.ASM | Norway |
| KDFPO.ASM | Portugal |
| KDFSG.ASM | Singapore |
| KDFSP.ASM | Spain |
| KDFSV.ASM | Sweden |
| KDFUK.ASM | United Kingdom |

### Code Pages (CPI files)

| Code Page | Name | Coverage |
|-----------|------|----------|
| CP437 | US English | Original IBM PC character set |
| CP850 | Multilingual | Western European languages |
| CP860 | Portuguese | Portugal-specific characters |
| CP862 | Hebrew | Hebrew script |
| CP863 | Canadian French | Quebec French characters |
| CP864 | Arabic | Arabic script |
| CP865 | Nordic | Scandinavian characters |

### Country Data (COUNTRY.SYS)

Country-specific formatting rules (date format, time format, currency symbol,
thousands separator, decimal separator, etc.). Loaded at boot time via
`COUNTRY=` directive in CONFIG.SYS.

---

## Building a Localized DOS 4.0

To build a localized version of DOS 4.0, you would need:

1. **Translated .MSG file** -- Replace `usa-ms.msg` with localized equivalent
   (e.g., `nld-ms.msg` for Dutch)
2. **Correct keyboard layout** -- Already available in KEYBOARD.SYS for 17 countries
3. **Correct code page** -- Already available in CPI files
4. **Country data** -- Already in COUNTRY.SYS

The extraction tools allow reconstructing .MSG files from international DOS binaries
(retail disks from archive.org, etc.), enabling localized builds without having the
original .MSG files.

### Extraction Workflow

```bash
# For each utility, extract messages from localized binary:
python3 tools/extract_localized_messages.py \
    v4.0/src/CMD/FORMAT/format.clb \
    dutch_dos/FORMAT.COM \
    > nl-NL/format.msg

# Repeat for all 48 utilities
# Combine into complete NL-NL.MSG file
```

---

## Known International DOS 4.x Releases

Available on archive.org and other sources:

- Dutch (Netherlands)
- French
- German
- Italian
- Spanish
- Portuguese
- Swedish
- Norwegian
- Danish
- Japanese (DOS/V variant, significantly different)
- Korean
- Arabic (ADOS)
- Hebrew (HDOS)
- Russian (RDOS 4.01)

Each of these could potentially have its messages extracted using our tools to
reconstruct the missing .MSG files.

---

## Sources

- DOS 4.0 source: `v4.0/src/` (this repository)
- BUILDMSG documentation: Inferred from source code and .CL* file structure
- Message system macros: `v4.0/src/INC/MSGSERV.ASM`
- Master message file: `v4.0/src/MESSAGES/USA-MS.MSG`
- OS/2 Museum: https://www.os2museum.com/wp/ms-dos-oaks/
- DOS Wikipedia: https://en.wikipedia.org/wiki/MS-DOS
